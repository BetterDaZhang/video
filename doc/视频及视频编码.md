# 视频编码

### 1. 视频编码相关概念

​	视频是利用人眼视觉暂留的原理，通过播放一系列的图片，使人眼产生运动的感觉。单纯传输视频画面，视频量非常大，对现有的网络和存储来说是不可接受的。为了能够使视频便于传输和存储，人们发现视频有大量重复的信息，如果将重复信息在发送端去掉，在接收端恢复出来，这样就大大减少了视频数据的文件，因此有了H.264视频压缩标准。

#### 1.1 软编码和硬编码

​	**概念**

​	软编码：使用CPU进行编码。

​	硬编码：不使用CPU进行编码，使用显卡GPU,专用的DSP、FPGA、ASIC芯片等硬件进行编码。

​	**比较**

​	软编码：实现直接、简单，参数调整方便，升级易，但CPU负载重，性能较硬编码低，低码率下质量通常比硬编码要好一点。

​	硬编码：性能高，低码率下通常质量低于硬编码器，但部分产品在GPU硬件平台移植了优秀的软编码算法（如X264）的，质量基本等同于软编码。

#### 1.2 视频存储过程

（1）成像
主要靠镜头来完成，拍摄主体反射的光线通过镜头进入相机后聚焦，形成清晰图像。

（2）光电转换
图像落在CCD/CMOS光电器材上，通过光电转换形成电信号。

（3）记录

​	![](http://p1yseh5av.bkt.clouddn.com/18-1-8/38647314.jpg)

​	经处理器加工，进行编码压缩，然后把信号记录在磁带或存储卡上。

#### 1.3 视频相关专业术语

**（1）视频**：
连续的图象变化每秒超过24帧（Frame）画面以上时，根据视觉暂留原理，人眼无法辨别单幅的静态画面，看上去是平滑连续的视觉效果，这样连续的画面叫做视频。

**（2）帧(Frame)：**
是影像中常用的最小单位，相当于电影中胶片的每一格镜头，一帧就是一副静止的画面，连续的帧就形成了视频。

**（3）帧速率（FPS）：**
每秒钟所传输图片的个数，也可以理解为处理器每秒刷新的次数，通常用FPS标识，当然帧数越高，画面也就越流畅。

**（4）转码 ：**

**指将一段多媒体包括音频、视频或者其他的内容从一种编码格式转换成为另外一种编码格式。（原视频 -- 解码 -- 像素数据 -- 编码 -- 目标视频）**
（原音频 -- 解码 -- 音频数据 -- 编码 -- 目标音频）

**（5）视频编码：**

讲到视频编码，大家可能都会问为什么视频要编码？

--- 要知道，采集的原始音视频信号体积都非常大，里面有很多相同的、眼看不到的、耳听不到的内容，比如，如果视频不经过压缩编码的话，体积通常是非常大的，一部电影可能就要上百G的空间。
--- 专业的来说，视频编码也就是文件当中的视频所采用的压缩算法，视频编码的主要作用是将视频像素数据（RGB，YUV等）压缩成为视频码流，从而降低视频的数据量。

**（6）视频解码：**
有了编码，当然也需要有解码。
因为压缩（编码）过的内容无法直接使用，使用（观看）时必须解压缩，还原为原始的信号（比如视频中某个点的颜色等），这就是“解码“或者”解压缩“。

**（7）采样频率：**
指录音设备在一秒钟内对声音信号的采样次数，它用赫兹（Hz）来表示，比如44.1KHz采样率的声音就是要花费44000个数据点来描述1秒钟的声音波形。原则上采样率越高，声音质量越好。

![](http://p1yseh5av.bkt.clouddn.com/18-1-8/68384978.jpg)

**（8）采样位数: **
表示了计算机度量声音波形幅度（音量）的精度，就是通常所说的声卡的位数。

就像表示颜色的位数一样（8位表示256种颜色，16位表示65536种颜色），有8位，16位，24位等。这个数值越大，解析度就越高，录制和回放的声音就越真实。
每一个采样点都需要用一个数值来表示大小，这个数值的数据类型大小可以是：8bit、16bit、32bit 等等，位数越多，表示得就越精细，声音质量自然就越好，而数据量也会成倍增大。我们在音频采样过程中常用的位宽是 8bit 或者 16bit。

**（9）比特率（码率）：**
表示单位时间（1秒）内传送的比特数，一般我们用的单位是kbps，其英文是 Kilobits per second，意即“千位每秒”（根据发音亦译作“千比特每秒”），意思是说每过一秒钟，有多少千比特的数据流过，因此码率也经常被称为“比特率”。

--- **音频中** 码率：就是音频文件或者音频流中1秒中的数据量，如1.44Mbps，就是1秒钟内的数据量1.44Mbits 。 码率越高，传送的数据越大，音质越好，

**声音比特率 = 采样率（Hz） x 采样位数（bit） x 声道数.**
--- 视频中 码率：原理与声音中的相同，都是指由模拟信号转换为数字信号后，单位时间内的二进制数据量，通俗来讲就是把每秒显示的图片进行压缩后的数据量。

**视频比特率（位/秒）= (画面尺寸彩色位数（bit）帧数)**

```
假设有一张标准音乐CD光盘容量是746.93MB（注意大B是字节，小b是位。一字节（B）等于8位（b）。）
CD音频是以采样率为44.1KHZ，采样位数为16位，左右双声道（立体声）进行采样的。而一张标准CD光盘的时长是74分钟。
那么容量计算公式为：(44100 x 16 x 2)/8 x (74 x 60)=783216000字节 转为MB为 783216000/1024/1024=746.93MB(兆字节)
```

**（9）场频：**

**场频**又称为**刷新频率**，即显示器的[垂直扫描频率](https://link.jianshu.com/?t=http://baike.baidu.com/view/115324.htm)，指显示器每秒所能显示的图象次数，单位为赫兹(Hz)。

一般在60-100Hz左右 场频也叫屏幕刷新频率，指屏幕在每秒钟内更新的次数。

>  1Hz代表每秒钟周期震动1次，60Hz代表每秒周期震动60次。

人眼睛的视觉暂留约为每秒16-24次左右，因此只要以每秒30次或更短的时间间隔来更新屏幕画面，就可以骗过人的眼睛，让我们以为画面没有变过。

实际上每秒30次的屏幕刷新率所产生的闪烁现象我们的眼睛仍然能够察觉从而产生疲劳的感觉。所以屏幕的场频越高，画面越稳定，使用者越感觉舒适。

另外：荧光屏上涂的是中短余辉荧光材料，如果电子枪不进行不断的反复“点亮”、“熄灭”荧光点 的话，就会导致图像变化时前面图像的残影滞留在屏幕上。

一般屏幕刷新率场频在每秒75次以上人眼就完全觉察不到了，所以建议场频设定在75Hz-85Hz之间，这足以满足一般使用者的需求了。

场频越大，图象刷新的次数越多，图象显示的闪烁就越小，画面质量越高。注意，这里的所谓“刷新次数”和我们通常在描述游戏速度时常说的“画面帧数”是两个截然不同的概念。后者指经电脑处理的动态图像每秒钟显示显像管电子枪的扫描频率。

场频与图像内容的变化没有任何关系，即便屏幕上显示的是静止图像，电子枪也照常更新。扫描频率过低会导致屏幕有明显的闪烁感，即稳定性差，容易造成眼睛疲劳。早期显示器通常支持60Hz的扫描频率，但是不久以后的调查表明，仍然有5%的人在这种模式下感到闪烁，因此VESA组织于1997年对其进行修正，规定**85Hz**逐行扫描为无闪烁的标准场频。

#### 1.4 无损压缩和有损压缩

无损压缩和有损压缩的区别是什么？
**有损压缩**：相当于一本书页数特别多，文字特别多，加入我们把书中修饰词去掉，啰嗦的情节去掉，虽然去掉这些，但是核心思想还没变，这就是类似于有损压缩。

**无损压缩**：相当于一本书特别长，我们把里面重复出现的人名，地名，用符号代替，然后书中标注上所有这些符号所代表的人名或地名，这样就短了些，这种就类似于无损压缩 。

#### 1.5 视频的构成

一个完整的视频文件是由音频和视频2部分组成的，而视音频又是由封装格式和编码格式构成，我们在表面看到的如AVI、RMVB、MKV、WMV、MP4、3GP、FLV等文件其实只能算是一种**封装**标准，一个外壳。
外壳里面核心还有一层是编码文件，**编码文件**经过封装后，才成为我们现在看到的.mp4 .avi等视频。如H.264、mpeg-4等就是视频编码格式, MP3、AAC等就是音频编码格式。

**（1）封装格式**

例如：将一个H.264视频编码文件和一个MP3视频编码文件按AVI封装标准封装以后，就得到一个AVI后缀的视频文件，这个就是我们常见的AVI视频文件了。

部分技术先进的容器还可以同时封装多个视频、音频编码文件，甚至同时封装进字幕，如MKV封装格式。MKV文件可以做到一个文件包括多语种发音、多语种字幕，适合不同人的需要。

```
（1）封装格式（也叫容器）就是将已经编码压缩好的视频轨和音频轨按照一定的格式放到一个文件中，也就是说仅仅是一个外壳，可以把它当成一个放视频轨和音频轨的文件夹也可以。
（2）通俗点说视频轨相当于饭，而音频轨相当于菜，封装格式就是一个碗，或者一个锅，用来盛放饭菜的容器。
（3）封装格式和专利是有关系的，关系到推出封装格式的公司的盈利。
（4）有了封装格式，才能把字幕，配音，音频和视频组合起来。
（5）常见的AVI、RMVB、MKV、ASF、WMV、MP4、3GP、FLV等文件都指的是一种封装格式。
```

例子： MKV封装格式

![](http://p1yseh5av.bkt.clouddn.com/18-1-8/89922982.jpg)

**（2）编码格式**

​	编码格式指的是对封装格式中视频流数据的压缩编码方式的一种描述。
​	视频不进行压缩的话，体积会非常大。

​	**视频压缩**，主要压缩了哪些东西：
​	空间冗余：图像相邻像素之间有较强的相关性
​	时间冗余：视频序列的相邻图像之间内容相似
​	编码冗余：不同像素值出现的概率不同
​	视觉冗余：人的视觉系统对某些细节不敏感
​	知识冗余：规律性的结构可由先验知识和背景知识得到

![](http://p1yseh5av.bkt.clouddn.com/18-1-8/30676233.jpg)



### 2. H.264编码原理以及I帧B帧P帧

#### 2.1 H.264编码原理

​	H.264是新一代的编码标准，以高压缩高质量和支持多种网络的流媒体传输著称，在编码方面，我理解的他的理论依据是：参照一段时间内图像的统计结果表明，在相邻几幅图像画面中，一般有差别的像素只有10%以内的点,亮度差值变化不超过2%，而色度差值的变化只有1%以内。所以对于一段变化不大图像画面，我们可以先编码出一个完整的图像帧A，随后的B帧就不编码全部图像，只写入与A帧的差别，这样B帧的大小就只有完整帧的1/10或更小！B帧之后的C帧如果变化不大，我们可以继续以参考B的方式编码C帧，这样循环下去。这段图像我们称为一个序列（序列就是有相同特点的一段数据），当某个图像与之前的图像变化很大，无法参考前面的帧来生成，那我们就结束上一个序列，开始下一段序列，也就是对这个图像生成一个完整帧A1，随后的图像就参考A1生成，只写入与A1的差别内容。

​	H.264采用的核心算法是帧内压缩和帧间压缩，帧内压缩是生成I帧的算法，帧间压缩是生成B帧和P帧的算法。

#### 2.2 序列

​	在H264中图像以序列为单位进行组织，一个序列是一段图像编码后的数据流，以I帧开始，到下一个I帧结束。

​	一个序列的第一个图像叫做 IDR 图像（立即刷新图像），IDR 图像都是 I 帧图像。H.264 引入 IDR 图像是为了解码的重同步，当解码器解码到 IDR 图像时，立即将参考帧队列清空，将已解码的数据全部输出或抛弃，重新查找参数集，开始一个新的序列。这样，如果前一个序列出现重大错误，在这里可以获得重新同步的机会。IDR图像之后的图像永远不会使用IDR之前的图像的数据来解码。

​	一个序列就是一段内容差异不太大的图像编码后生成的一串数据流。当运动变化比较少时，一个序列可以很长，因为运动变化少就代表图像画面的内容变动很小，所以就可以编一个I帧，然后一直P帧、B帧了。当运动变化多时，可能一个序列就比较短了，比如就包含一个I帧和3、4个P帧。

#### 2.3 I帧，P帧，B帧

​	视频里边的原始图像数据会采用 H.264编码格式进行压缩，音频采样数据会采用 AAC 编码格式进行压缩。视频内容经过编码压缩后，确实有利于存储和传输。不过当要观看播放时，相应地也需要解码过程。因此编码和解码之间，显然需要约定一种编码器和解码器都可以理解的约定。就视频图像编码和解码而言，这种约定很简单：

​	**编码器将多张图像进行编码后生产成一段一段的 GOP ( Group of Pictures ) ， 解码器在播放时则是读取一段一段的 GOP 进行解码后读取画面再渲染显示。**

​	GOP ( Group of Pictures) 是一组连续的画面，由一张 I 帧和数张 B / P 帧组成，是视频图像编码器和解码器存取的基本单位，它的排列顺序将会一直重复到影像结束。

- **I帧**

  **帧内编码帧** ，I帧表示关键帧，你可以理解为这一帧画面的完整保留；解码时只需要本帧数据就可以完成（因为包含完整画面）。

  帧内编码帧 又称intra picture，I 帧通常是每个 GOP（MPEG 所使用的一种视频压缩技术）的第一个帧，经过适度地压缩，做为随机访问的参考点，可以当成图象。I帧可以看成是一个图像经过压缩后的产物。

  I帧的特点：

  - 它是一个全帧压缩编码帧。它将全帧图像信息进行JPEG压缩编码及传输
  - 解码时仅用I帧的数据就可重构完整图像
  - I帧描述了图像背景和运动主体的详情
  - I帧不需要参考其他画面而生成
  - I帧是P帧和B帧的参考帧(其质量直接影响到同组中以后各帧的质量)
  - I帧是帧组GOP的基础帧(第一帧),在一组中只有一个I帧
  - I帧不需要考虑运动矢量
  - I帧所占数据的信息量比较大

- **P帧**

  **前向预测编码帧**。P帧表示的是这一帧跟之前的一个关键帧（或P帧）的差别，解码时需要用之前缓存的画面叠加上本帧定义的差别，生成最终画面。（也就是差别帧，P帧没有完整画面数据，只有与前一帧的画面差别的数据）

  前向预测编码帧 又称predictive-frame，通过充分将低于图像序列中前面已编码帧的时间冗余信息来压缩传输数据量的编码图像，也叫预测帧。

  **P帧的预测与重构：**P帧是以I帧为参考帧,在I帧中找出P帧“某点”的预测值和运动矢量,取预测差值和运动矢量一起传送。在接收端根据运动矢量从I帧中找出P帧“某点”的预测值并与差值相加以得到P帧“某点”样值,从而可得到完整的P帧。

  P帧特点:

  - P帧是I帧后面相隔1~2帧的编码帧
  - P帧采用运动补偿的方法传送它与前面的I或P帧的差值及运动矢量(预测误差)
  - 解码时必须将I帧中的预测值与预测误差求和后才能重构完整的P帧图像
  - P帧属于前向预测的帧间编码。它只参考前面最靠近它的I帧或P帧
  - P帧可以是其后面P帧的参考帧,也可以是其前后的B帧的参考帧
  - 由于P帧是参考帧,它*可能造成解码错误的扩散*
  - 由于是差值传送,P帧的压缩比较高

- **B帧**

  **双向预测内插编码帧**。B帧是双向差别帧，也就是B帧记录的是本帧与前后帧的差别（具体比较复杂，有4种情况，但我这样说简单些），换言之，要解码B帧，不仅要取得之前的缓存画面，还要解码之后的画面，通过前后画面的与本帧数据的叠加取得最终的画面。B帧压缩率高，但是解码时CPU会比较累。

  双向预测内插编码帧 又称bi-directional interpolated prediction frame，既考虑与源图像序列前面已编码帧，也顾及源图像序列后面已编码帧之间的时间冗余信息来压缩传输数据量的编码图像，也叫双向预测帧；

  **B帧的预测与重构：**B帧以前面的I或P帧和后面的P帧为参考帧,“找出”B帧“某点”的预测值和两个运动矢量,并取预测差值和运动矢量传送。接收端根据运动矢量在两个参考帧中“找出(算出)”预测值并与差值求和,得到B帧“某点”样值,从而可得到完整的B帧。

  B帧的特点：

  - B帧是由前面的I或P帧和后面的P帧来进行预测的
  - B帧传送的是它与前面的I或P帧和后面的P帧之间的预测误差及运动矢量
  - B帧是双向预测编码帧
  - B帧压缩比最高,因为它只反映丙参考帧间运动主体的变化情况,预测比较准确
  - B帧不是参考帧,*不会造成解码错误的扩散*

I、B、P各帧是根据压缩算法的需要，是人为定义的,它们都是实实在在的物理帧。一般来说，I帧的压缩率是7（跟JPG差不多），P帧是20，B帧可以达到50。可见使用B帧能节省大量空间，节省出来的空间可以用来保存多一些I帧，这样在相同码率下，可以提供更好的画质。

#### 2.4  DTS和PTS

PTS：Presentation Time Stamp。PTS主要用于度量解码后的视频帧什么时候被显示出来

DTS：Decode Time Stamp。DTS主要是标识读入内存中的ｂｉｔ流在什么时候开始送入解码器中进行解码。

在没有B帧存在的情况下DTS的顺序和PTS的顺序应该是一样的。

DTS主要用于视频的解码,在解码阶段使用.PTS主要用于视频的同步和输出.在display的时候使用.在没有B frame的情况下.DTS和PTS的输出顺序是一样的。

例子：

下面给出一个GOP为15的例子,其解码的参照frame及其解码的顺序都在里面:

![](http://p1yseh5av.bkt.clouddn.com/18-1-4/39664093.jpg)

如上图：I frame 的解码不依赖于任何的其它的帧.而p frame的解码则依赖于其前面的I frame或者P frame.B frame的解码则依赖于其前的最近的一个I frame或者P frame 及其后的最近的一个P frame.



### 来源

[H.264码流以及H.264编解码的基本概念](https://maxwellqi.github.io/ios-h264-summ/)

[H264编码原理以及I帧B帧P帧](https://www.jianshu.com/p/ea3fadae9d47?utm_campaign=maleskine&utm_content=note&utm_medium=seo_notes&utm_source=recommendation)

[视频、音频 学习知识整理](https://www.jianshu.com/p/614b3e6e641a?utm_campaign=maleskine&utm_content=note&utm_medium=seo_notes&utm_source=recommendation)

